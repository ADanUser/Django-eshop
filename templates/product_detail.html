{% extends "common.html" %} 

{% block styles %} 
{% load static %}
    <link rel="stylesheet" href="{% static 'detail.css' %}" />
{% endblock styles %} 

{% block content %}

<script>
    window.addEventListener('load', function(){
        decrease = document.getElementById("decrease");
        increase = document.getElementById("increase"); 
        counter = document.getElementById("counter");

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        increase.onclick = function (event) {
            let value = parseInt (counter. innerHTML);
            if (isNaN (value)) value = 0;
            if (value < {{ product.stock }}) value++;
            counter.innerHTML = value. toString();
        }

        decrease.onclick = function (event) {
            let value = parseInt (counter.innerHTML);
            if (isNaN (value)) value = 0;
            if (value > 0) value--;
            counter.innerHTML = value.toString();
        }

        fetch(`{% url 'cart' product.id %}`)
            .then((response) => {
                if (!response.ok) {
                    displayCardButton(false)
                    return response.json()
                } else {
                    displayCardButton(true);
                    return response.json()
                }
            }).then(response => {
                if (response.quantity) {
                    counter.innerHTML = response.quantity.toString();
                }
            });

        function displayCardButton(isRemove) {
            let infoContainer = document.querySelector(".info-container");
            
            let existingAdd = document.getElementById("add-to-cart");
            if (existingAdd) existingAdd.remove();
            
            let existingRemove = document.getElementById("remove-from-cart");
            if (existingRemove) existingRemove.remove();

            cartButton = document.createElement("a");
            
            if (!isRemove) {
                cartButton.className = "btn btn-danger"
                cartButton.id = "add-to-cart"
                cartButton.type = 'button'
                cartButton.innerHTML = 'Добавить в корзину'
                cartButton.onclick = addToCart;
            } else {
                cartButton.className = "btn btn-outline-danger"
                cartButton.id = "remove-from-cart"
                cartButton.type = 'button'
                cartButton.innerHTML = 'Удалить из корзины'
                cartButton.onclick = removeFromCart;
            }

            infoContainer.appendChild(cartButton);
        
        }

        function addToCart() {
            let body = {
                productId: {{ product.id }},
                quantity: parseInt(counter.innerHTML)       
            };
            fetch(`{% url 'cart' %}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(body)
            }).then((response) => {
                if (response.ok) displayCardButton(true);
            });
        }

        function removeFromCart() {
            fetch(`{% url 'cart' product.id %}`, {
                method: 'DELETE',
                headers: {
                    'content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            }).then((response) => {
                if (!response.ok) alert("Ошибка при удалении товара из корзины");
                else {
                    displayCardButton(false)
                    counter.innerHTML = '0';
                };
            });
        }
    })
</script>
<div class="container text-center mt-4">
    <h1 class="mb-3">{{ product.title }}</h1>

    <div class="d-flex flex-column align-items-center">
        <div class="d-flex flex-wrap gap-3 justify-content-center mb-4">
            {% for image in product.productimage_set.all %}
                <div style="width: 300px; height: 300px; overflow: hidden; border-radius: 8px; border: 1px solid #ddd;">
                    <img
                        src="{{ image.image.url }}"
                        class="w-100 h-100"
                        style="object-fit: cover;"
                        alt="{{ product.title }}"
                    />
                </div>           
            {% endfor %}
        </div>

        <div class="info-container text-center" style="max-width: 600px;">
            <p class="fs-5">{{ product.description }}</p>
            <h3 class="my-3">Цена: {{ product.price }}</h3>
            <div class="d-flex flex-column align-items-center my-3">
                <div class="d-flex align-items-center justify-content-center gap-3 mb-2">
                    <button id="decrease" class="qty-circle-btn" type="button">−</button>
                    <b id="counter" class="fs-5 fw-semibold">0</b>
                    <button id="increase" class="qty-circle-btn" type="button">+</button>
                </div>
            </div>
        
        </div>
    </div>
</div>
{% endblock %}
